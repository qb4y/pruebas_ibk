---
- name: "Validar variables requeridas"
  ansible.builtin.assert:
    that:
      - vcenter_hostname is defined and vcenter_hostname != ""
      - vcenter_username is defined and vcenter_username != ""
      - vcenter_password is defined and vcenter_password != ""
    fail_msg: "Variables requeridas faltantes: vcenter_hostname, vcenter_username, vcenter_password"
    success_msg: "Variables requeridas definidas"
  tags: [always, validation]

- name: "Validar conexion a vCenter"
  block:
    - name: "Intentar conexion a vCenter"
      community.vmware.vmware_about_info:
        hostname: "{{ vcenter_hostname }}"
        username: "{{ vcenter_username }}"
        password: "{{ vcenter_password }}"
        validate_certs: "{{ validate_certs | default(false) }}"
      register: vcenter_info

    - name: "Conexion exitosa a vCenter"
      ansible.builtin.debug:
        msg: "{{ conexion_exitosa | to_json }}"
      vars:
        conexion_exitosa:
          estado: "CONECTADO"
          vcenter: "{{ vcenter_hostname }}"
          version: "{{ vcenter_info.about_info.version }}"
          build: "{{ vcenter_info.about_info.build }}"
          conexion_exitosa: true
          timestamp: "{{ ansible_date_time.iso8601 }}"
          mensaje: "Conexion a vCenter establecida correctamente - CONFIGURACION INDEPENDIENTE"

  rescue:
    - name: "Error de conexion a vCenter"
      ansible.builtin.fail:
        msg:
          - "NO SE PUDO CONECTAR A VCENTER"
          - "Host: {{ vcenter_hostname }}"
          - "Usuario: {{ vcenter_username }}"
          - "Verifica conectividad y credenciales"

  always:
    - name: "Estado de la validacion"
      ansible.builtin.debug:
        msg: "Validacion de conexion completada - {{ 'EXITO' if vcenter_info is defined else 'FALLO' }}"

  tags: [always, validation]

- name: "Configuracion independiente confirmada"
  ansible.builtin.debug:
    msg:
      - "ðŸŽ¯ === CONFIGURACIÃ“N INDEPENDIENTE ACTIVA ==="
      - "âœ… NO dependemos de customization specs externos"
      - "âœ… ConfiguraciÃ³n completa en formato template_win"
      - "âœ… Usuarios con permisos reales configurados"
      - "âœ… DNS: 130.30.2.2, 130.30.2.147 (del XML)"
      - "âœ… Dominio: grupoib.local (del XML)"
      - "âœ… Usuario dominio: slu000 (con permisos)"
      - "âœ… Timezone: 45 (del XML)"
      - "âœ… IP especÃ­fica del windows.yml"
      - "ðŸš€ LISTO PARA APROVISIONAMIENTO INDEPENDIENTE COMPLETO"
  tags: [always, configuracion_independiente]
