---
- name: ğŸ§  Recolectar facts si no estÃ¡n presentes
  ansible.builtin.setup:
  when: ansible_os_family is not defined

- name: Verificar sistema operativo compatible
  ansible.builtin.assert:
    that:
      - ansible_os_family in ['RedHat', 'Windows']
    fail_msg: "âŒ {{ ansible_os_family | default('desconocido') }} no es compatible con este rol. Solo soporta RedHat family y Windows."
    success_msg: "âœ… Sistema operativo {{ ansible_os_family }} es compatible."

- name: Validar que CU_GRUPOS estÃ¡ definido
  ansible.builtin.assert:
    that:
      - CU_GRUPOS is defined
      - CU_GRUPOS | length > 0
    fail_msg: "âŒ Variable CU_GRUPOS no estÃ¡ definida o estÃ¡ vacÃ­a. Debe contener al menos un grupo."
    success_msg: "âœ… Variable CU_GRUPOS definida con {{ CU_GRUPOS | length }} grupo(s)."

- name: Definir mapeo de permisos por sistema operativo
  ansible.builtin.set_fact:
    permission_map:
      linux:
        1: ["wheel"]  # Administrador (wheel existe por defecto en RedHat)
        2: ["users"]  # Usuario estÃ¡ndar
        3: ["wheel"]  # Operador especializado (usamos wheel tambiÃ©n)
        4: ["users"]  # Solo lectura (usamos users)
        5: ["users"]  # Operador backup (usamos users)
      windows:
        1: "Administrators"     # Administrador
        2: "Users"             # Usuario estÃ¡ndar
        3: "Power Users"       # Operador especializado
        4: "Guests"            # Solo lectura
        5: "Backup Operators"  # Operador backup

- name: Validar cÃ³digos de permisos en CU_GRUPOS
  ansible.builtin.assert:
    that:
      - item.1.permisos in [1, 2, 3, 4, 5]
    fail_msg: "âŒ CÃ³digo de permiso invÃ¡lido '{{ item.1.permisos }}' para usuario '{{ item.1.nombre }}'. Debe ser 1-5."
    success_msg: "âœ… CÃ³digo de permiso vÃ¡lido para {{ item.1.nombre }}"
  loop: "{{ CU_GRUPOS | subelements('usuarios') }}"
  loop_control:
    label: "{{ item.1.nombre }} (permiso: {{ item.1.permisos }})"

- name: Establecer configuraciÃ³n por defecto para Linux
  ansible.builtin.set_fact:
    default_shell: "{{ CU_DEFAULT_SHELL | default('/bin/bash') }}"
    home_base_path: "{{ CU_HOME_BASE_PATH | default('/home') }}"
  when: ansible_os_family == 'RedHat'

- name: Establecer configuraciÃ³n por defecto para Windows
  ansible.builtin.set_fact:
    home_base_path: "{{ CU_HOME_BASE_PATH | default('C:\\Users') }}"
    force_password_change: "{{ CU_FORCE_PASSWORD_CHANGE | default(true) }}"
  when: ansible_os_family == 'Windows'

- name: Mostrar resumen de configuraciÃ³n
  ansible.builtin.debug:
    msg: |
      ğŸ”§ ConfiguraciÃ³n del rol crear_usuarios:
      ğŸ“Š Sistema: {{ ansible_os_family }}
      ğŸ‘¥ Grupos a crear: {{ CU_GRUPOS | length }}
      ğŸ‘¤ Total usuarios: {{ CU_GRUPOS | map(attribute='usuarios') | flatten | length }}
      ğŸ  Ruta base home: {{ home_base_path }}
      ğŸ§ª Modo fake: {{ CU_FAKE_ENVIRONMENT | default(false) }}

- name: Ejecutar creaciÃ³n en Linux
  ansible.builtin.include_tasks: linux.yml
  when: 
    - ansible_os_family == 'RedHat'
    - not (CU_FAKE_ENVIRONMENT | default(false))

- name: Ejecutar creaciÃ³n en Windows
  ansible.builtin.include_tasks: windows.yml
  when: 
    - ansible_os_family == 'Windows'
    - not (CU_FAKE_ENVIRONMENT | default(false))

- name: Simular creaciÃ³n (modo fake)
  ansible.builtin.debug:
    msg: |
      ğŸ§ª MODO SIMULACIÃ“N ACTIVADO
      Los siguientes usuarios y grupos serÃ­an creados:
      {% for grupo in CU_GRUPOS %}
      ğŸ“ Grupo: {{ grupo.nombre }}
      {% for usuario in grupo.usuarios %}
        ğŸ‘¤ Usuario: {{ usuario.nombre }} (Permiso: {{ usuario.permisos }})
      {% endfor %}
      {% endfor %}
  when: CU_FAKE_ENVIRONMENT | default(false)

- name: âœ… Resumen final de ejecuciÃ³n
  ansible.builtin.debug:
    msg: |
      âœ… Rol crear_usuarios completado en {{ inventory_hostname }}
      ğŸ“Š Sistema: {{ ansible_os_family }}
      ğŸ‘¥ Grupos procesados: {{ CU_GRUPOS | length }}
      ğŸ‘¤ Usuarios procesados: {{ CU_GRUPOS | map(attribute='usuarios') | flatten | length }}
      ğŸ§ª Modo fake: {{ CU_FAKE_ENVIRONMENT | default(false) }}
  when: not (CU_FAKE_ENVIRONMENT | default(false))