---
- name: ğŸ“ Crear grupos locales (Windows)
  ansible.windows.win_group:
    name: "{{ item.nombre }}"
    description: "Grupo creado por Ansible - {{ item.nombre }}"
    state: present
  loop: "{{ CU_GRUPOS }}"
  register: grupos_creados_win

- name: Mostrar grupos creados (Windows)
  ansible.builtin.debug:
    msg: "ğŸ“ Grupo '{{ item.item.nombre }}': {{ 'Creado' if item.changed else 'Ya existÃ­a' }}"
  loop: "{{ grupos_creados_win.results }}"
  loop_control:
    label: "{{ item.item.nombre }}"

- name: ğŸ² Generar contraseÃ±as aleatorias para usuarios
  ansible.builtin.set_fact:
    generated_passwords: "{{ generated_passwords | default({}) | combine({item.1.nombre: lookup('password', '/dev/null length=12 chars=ascii_letters,digits,!@#$%')}) }}"
  loop: "{{ CU_GRUPOS | subelements('usuarios') }}"
  loop_control:
    label: "{{ item.1.nombre }}"
  no_log: true  # No mostrar contraseÃ±as en logs

- name: ğŸ‘¤ Crear usuarios locales (Windows)
  ansible.windows.win_user:
    name: "{{ item.1.nombre }}"
    description: "Usuario creado por Ansible - {{ item.1.nombre }}"
    password: "{{ generated_passwords[item.1.nombre] }}"
    groups:
      - "{{ item.0.nombre }}"
      - "{{ permission_map.windows[item.1.permisos] }}"
    groups_action: add
    state: present
    user_cannot_change_password: false
    password_never_expires: false
    password_expired: "{{ force_password_change }}"
  loop: "{{ CU_GRUPOS | subelements('usuarios') }}"
  loop_control:
    label: "{{ item.1.nombre }} -> {{ item.0.nombre }}"
  register: usuarios_creados_win

- name: Mostrar usuarios creados (Windows)
  ansible.builtin.debug:
    msg: |
      ğŸ‘¤ Usuario '{{ item.item.1.nombre }}': {{ 'Creado' if item.changed else 'Ya existÃ­a' }}
      ğŸ“ Grupo principal: {{ item.item.0.nombre }}
      ğŸ” Grupo de permisos: {{ permission_map.windows[item.item.1.permisos] }}
      ğŸ”’ Cambio de contraseÃ±a requerido: {{ force_password_change }}
  loop: "{{ usuarios_creados_win.results }}"
  loop_control:
    label: "{{ item.item.1.nombre }}"

- name: ğŸ” Configurar permisos especiales para administradores (Windows)
  ansible.windows.win_group_membership:
    name: "Administrators"
    members:
      - "{{ item.1.nombre }}"
    state: present
  loop: "{{ CU_GRUPOS | subelements('usuarios') }}"
  loop_control:
    label: "{{ item.1.nombre }}"
  when: item.1.permisos == 1  # Solo administradores
  register: admin_permisos

- name: Mostrar permisos administrativos configurados
  ansible.builtin.debug:
    msg: "ğŸ” Permisos de administrador configurados para: {{ item.item.1.nombre }}"
  loop: "{{ admin_permisos.results | default([]) }}"
  loop_control:
    label: "{{ item.item.1.nombre }}"
  when: item.changed | default(false)

- name: ğŸ” Verificar usuarios creados (Windows)
  ansible.windows.win_shell: |
    Get-LocalUser -Name "{{ item.1.nombre }}" | Select-Object Name, Enabled, LastLogon
  loop: "{{ CU_GRUPOS | subelements('usuarios') }}"
  loop_control:
    label: "{{ item.1.nombre }}"
  register: user_verification_win
  failed_when: false

- name: Mostrar verificaciÃ³n de usuarios
  ansible.builtin.debug:
    msg: |
      ğŸ‘¤ Usuario: {{ item.item.1.nombre }}
      ğŸ“Š Estado: {{ 'Verificado' if item.rc == 0 else 'Error en verificaciÃ³n' }}
  loop: "{{ user_verification_win.results }}"
  loop_control:
    label: "{{ item.item.1.nombre }}"

- name: ğŸ” Verificar membresÃ­a de grupos (Windows)
  ansible.windows.win_shell: |
    $user = "{{ item.1.nombre }}"
    $groups = Get-LocalUser -Name $user | ForEach-Object { 
        Get-LocalGroup | Where-Object { 
            (Get-LocalGroupMember -Group $_.Name -ErrorAction SilentlyContinue).Name -contains "$env:COMPUTERNAME\$user" 
        } 
    }
    $groups.Name -join ", "
  loop: "{{ CU_GRUPOS | subelements('usuarios') }}"
  loop_control:
    label: "{{ item.1.nombre }}"
  register: group_membership_win
  failed_when: false

- name: Mostrar membresÃ­a de grupos
  ansible.builtin.debug:
    msg: |
      ğŸ‘¤ Usuario: {{ item.item.1.nombre }}
      ğŸ‘¥ Grupos: {{ item.stdout | default('Error al verificar') | trim }}
  loop: "{{ group_membership_win.results }}"
  loop_control:
    label: "{{ item.item.1.nombre }}"

- name: ğŸ  Verificar directorios de perfil (Windows)
  ansible.windows.win_stat:
    path: "{{ home_base_path }}\\{{ item.1.nombre }}"
  loop: "{{ CU_GRUPOS | subelements('usuarios') }}"
  loop_control:
    label: "{{ item.1.nombre }}"
  register: profile_verification_win

- name: Mostrar verificaciÃ³n de perfiles
  ansible.builtin.debug:
    msg: "ğŸ  Perfil {{ item.item.1.nombre }}: {{ 'Existe' if item.stat.exists else 'Se crearÃ¡ en primer login' }}"
  loop: "{{ profile_verification_win.results }}"
  loop_control:
    label: "{{ item.item.1.nombre }}"

- name: ğŸ”’ Configurar polÃ­tica de contraseÃ±as para usuarios (Windows)
  ansible.windows.win_shell: |
    net user "{{ item.1.nombre }}" /passwordchg:{{ 'yes' if force_password_change else 'no' }}
  loop: "{{ CU_GRUPOS | subelements('usuarios') }}"
  loop_control:
    label: "{{ item.1.nombre }}"
  register: password_policy
  changed_when: false
  failed_when: false

- name: âŒ Fallar si algÃºn usuario no fue creado correctamente (Windows)
  ansible.builtin.fail:
    msg: "âŒ Error: Usuario {{ item.item.1.nombre }} no fue creado correctamente en Windows."
  loop: "{{ user_verification_win.results }}"
  loop_control:
    label: "{{ item.item.1.nombre }}"
  when: item.rc != 0

- name: âœ… ConfirmaciÃ³n de creaciÃ³n exitosa (Windows)
  ansible.builtin.debug:
    msg: |
      âœ… Usuarios y grupos creados exitosamente en {{ inventory_hostname }}
      ğŸ“Š Grupos creados: {{ CU_GRUPOS | map(attribute='nombre') | join(', ') }}
      ğŸ‘¤ Usuarios creados: {{ CU_GRUPOS | map(attribute='usuarios') | flatten | map(attribute='nombre') | join(', ') }}
      ğŸªŸ Sistema: {{ ansible_os_name }} {{ ansible_os_family }}
      ğŸ  Ruta base: {{ home_base_path }}
      ğŸ”’ Cambio de contraseÃ±a: {{ force_password_change }}

- name: ğŸ” OUTPUT - ContraseÃ±as generadas automÃ¡ticamente
  ansible.builtin.debug:
    msg: |
      ğŸ” CONTRASEÃ‘AS GENERADAS AUTOMÃTICAMENTE:
      {% for usuario in CU_GRUPOS | map(attribute='usuarios') | flatten %}
      ğŸ‘¤ {{ usuario.nombre }}: {{ generated_passwords[usuario.nombre] }}
      {% endfor %}
      
      âš ï¸  IMPORTANTE: Estas contraseÃ±as son temporales y deben cambiarse en el primer login.
      âš ï¸  Guarda estas contraseÃ±as de forma segura antes de cerrar esta ejecuciÃ³n.