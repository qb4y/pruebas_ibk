---

- name: Install patches from a folder
  block:

    - name: Find all rpm files in repository folder
      ansible.builtin.find:
        paths: "{{ package_download_location }}"
        patterns: "*.rpm"
      register: rpm_files

    - name: Set rpm_list
      ansible.builtin.set_fact:
        rpm_list: "{{ rpm_files.files | map(attribute='path') | list }}"

    - name: Install all updates in repository folder - version 7 and below
      ansible.builtin.yum:
        name: "{{ rpm_list }}"
        state: present
        exclude: "{{ yum_exclude_patch_list }}"
        update_cache: true
        lock_timeout: 180
        enablerepo: "{{ enable_repo }}"
        disablerepo: "{{ disable_repo }}"
        disable_gpg_check: "{{ disable_gpg_check }}"
      register: yum_update_rcp_result
      async: "{{ async_value }}"
      poll: "{{ poll_value }}"
      when: ansible_distribution_major_version | int < 8

    - name: Install all updates in repository folder - version 8 and above
      ansible.builtin.dnf:
        name: "{{ rpm_list }}"
        state: present
        exclude: "{{ yum_exclude_patch_list }}"
        update_cache: true
        lock_timeout: 180
        enablerepo: "{{ enable_repo }}"
        disablerepo: "{{ disable_repo }}"
        disable_gpg_check: "{{ disable_gpg_check }}"
      register: dnf_update_rcp_result
      async: "{{ async_value }}"
      poll: "{{ poll_value }}"
      when: ansible_distribution_major_version | int >= 8

    - name: Set patching result
      ansible.builtin.set_fact:
        update_rcp_result:
          "{% if yum_update_rcp_result is not skipped
          %}{{ yum_update_rcp_result }}{% else
          %}{{ dnf_update_rcp_result }}{% endif %}"

  rescue:

    - name: Return code incase of redhat update_all or rcp_all fails
      ansible.builtin.include_role:
        name: returncode
      vars:
        rc_support: "developer"
        rc_group: "component_playbook"
        rc_number: 5009
        rc_message:
          "Redhat update_all or rcp_all patching failed.
          Below is the error:
          {{ update_rcp_result.msg }}"

    - name: Failure - patches not installed
      ansible.builtin.set_fact:
        patch_status: 'failure'
        exec_message:
          "{{ exec_message }}
          Patching result:\n\n
          Patch installation FAILED, please perform manual patching.\n\n"

    - name: Send communication
      ansible.builtin.include_tasks: send_notification.yml

    - name: Remove lock file
      ansible.builtin.file:
        path:
          /etc/ansible/facts.d{{
          '' if lock_file_dir.changed else '/unix_patching.fact' }}
        state: absent

    - name: End the job for the host {{ inventory_hostname }}
      ansible.builtin.fail:
        msg: "Redhat update_all or rcp_all patching failed"
      when:
        - fail_on_error | bool
        - not teams_notification

    - name: Set continue_execution flag
      ansible.builtin.set_fact:
        continue_execution: false

# Nothing to do here, all packages are up to date
- name: Nothing to do here, all packages are up to date
  when:
    - update_rcp_result is not failed
    - not update_rcp_result.changed
  block:

    - name: Set returncode
      ansible.builtin.include_role:
        name: returncode
      vars:
        rc_success: true
        rc_message: "Nothing to do here, all packages are up to date"

    - name: Set exec_message
      ansible.builtin.set_fact:
        patch_status: 'nothing_to_do'
        exec_message:
          "{{ exec_message }}
          Patching result:\n\n
          Nothing to do here, all packages are up to date.\n\n"

- name: Patches installed successfully
  when:
    - patch_status != 'nothing_to_do'
    - update_rcp_result is not failed
  block:
    - name: Set returncode
      ansible.builtin.include_role:
        name: returncode
      vars:
        rc_success: true
        rc_message: "Patches installed successfully"

    - name: Set exec_message
      ansible.builtin.set_fact:
        patch_status: 'success'
        exec_message:
          "{{ exec_message }}
          Patching result:\n\n
          Patches installed successfully.\n\n"
