---
# - name: ğŸ” Obtener todos los secretos desde Vault
#   ansible.builtin.import_role:
#     name: vault_core
#   delegate_to: localhost
#   run_once: true
#   tags: ["vault"]

# - name: ğŸªª Mostrar secretos UIM traÃ­dos desde Vault
#   ansible.builtin.debug:
#     var: vault_all_secrets.uim
#   run_once: true
#   delegate_to: localhost
#   tags: ["vault"]

# - name: ğŸ” Cargar variables de UIM a todos los hosts
#   ansible.builtin.set_fact:
#     uim: "{{ vault_all_secrets.uim }}"

# - name: ğŸ” Propagar variables de UIM a todos los hosts
#   ansible.builtin.set_fact:
#     DOMAIN: "{{ uim.uim_domain }}"
#     FIRST_PROBE_PORT: "{{ uim.uim_first_probe_port }}"
#     HUB: "{{ uim.uim_hub }}"
#     HUBIP: "{{ uim.uim_hubip }}"
#     HUBPORT: "{{ uim.uim_hubport }}"
#     HUBROBOTNAME: "{{ uim.uim_hubrobotname }}"
#     ROBOTIP: "{{ uim.uim_robotip }}"
#     ROBOTNAME: "{{ uim.uim_robotname }}"
#   delegate_to: localhost
#   run_once: true
#   tags: ["vault"]

# - name: Configurar variables para provider_minio
#   ansible.builtin.set_fact:
#     provider_minio_product: "uim"

# - name: ğŸ“¦ Obtener URLs de descarga desde MinIO
#   ansible.builtin.import_role:
#     name: provider_minio
#   tags: ["minio"]

# - name: ğŸ” Propagar credenciales MinIO para descargas
#   ansible.builtin.set_fact:
#     minio_user: "{{ minio_user }}"
#     minio_password: "{{ minio_password }}"
#     installer_path: "{{ installer_path }}"
#   tags: ["minio"]

# - name: âœ… Validar que las credenciales MinIO estÃ¡n definidas
#   ansible.builtin.assert:
#     that:
#       - minio_user is defined
#       - minio_password is defined
#       - installer_path is defined
#     fail_msg: "âŒ Las credenciales de MinIO no estÃ¡n definidas correctamente desde Vault."
#   tags: ["minio"]

# - name: ğŸ” Mostrar URL generada del instalador UIM
#   ansible.builtin.debug:
#     var: uim_installer_url
#   tags: [minio]

# - name: âœ… Validar URLs de descarga
#   ansible.builtin.assert:
#     that:
#       - uim_installer_url is defined
#       - uim_cert_urls is defined
#     fail_msg: |
#       âŒ No se pudieron generar las URLs de descarga desde MinIO.
#       Verifica:
#       1. Conectividad con MinIO
#       2. Archivos existen en bucket: {{ minio_bucket }}
#       3. MinIO Client (mc) estÃ¡ disponible en el execution environment
#   tags: [minio]

- name: Establecer variables de configuraciÃ³n para UIM
  ansible.builtin.set_fact:
    DOMAIN: "KYNDOMAIN"
    FIRST_PROBE_PORT: 48000
    HUB: "KYNHUB"
    HUBIP: "10.0.0.100"
    HUBPORT: 48002
    HUBROBOTNAME: "hubrobot"
    ROBOTIP: "10.0.0.217"
    ROBOTNAME: "test-agent"
    uim_installer_url: "https://minio.fake/uim/robot_installer.exe"
    uim_cert_urls:
      - "https://minio.fake/uim/cert1.pem"
      - "https://minio.fake/uim/cert2.pem"

- name: Mostrar configuraciÃ³n de instalaciÃ³n de UIM
  ansible.builtin.debug:
    msg:
      - "ğŸŒ URL de instalaciÃ³n: {{ uim_installer_url }}"
      - "ğŸ“œ Cantidad de certificados: {{ uim_cert_urls | length }}"
      - "ğŸ“ HUB: {{ HUB }} ({{ HUBIP }}:{{ HUBPORT }})"
      - "ğŸ¤– ROBOT: {{ ROBOTNAME }} ({{ ROBOTIP }})"
      - "ğŸ“¦ Primer puerto disponible: {{ FIRST_PROBE_PORT }}"

# - name: Ejecutar prechecks para Linux
#   ansible.builtin.import_tasks: ../prechecks/linux.yml
#   when: target_platform == 'linux'

- name: Ejecutar tareas de instalaciÃ³n en Linux
  ansible.builtin.include_tasks: linux.yml
  when: target_platform == 'linux'

# - name: Ejecutar prechecks para Windows
#   ansible.builtin.import_tasks: ../prechecks/windows.yml
#   when: target_platform == 'windows'

- name: Ejecutar tareas de instalaciÃ³n en Windows
  ansible.builtin.include_tasks: windows.yml
  when: target_platform == 'windows'
