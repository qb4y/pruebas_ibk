---

- name: ğŸ§ª Verificar que el sistema operativo sea Windows
  ansible.builtin.assert:
    that:
      - ansible_os_family == "Windows"
    fail_msg: "âŒ Este rol solo puede ejecutarse en sistemas Windows."
    success_msg: "âœ… Sistema operativo compatible: {{ ansible_os_family }}"

- name: ğŸ§ª Verificar existencia de PowerShell
  ansible.windows.win_command: powershell -Command "$PSVersionTable.PSVersion"
  register: ps_check
  failed_when: ps_check.rc != 0
  changed_when: false

- name: âœ… Mostrar versiÃ³n de PowerShell
  ansible.builtin.debug:
    msg: "VersiÃ³n de PowerShell: {{ ps_check.stdout_lines | join(' ') }}"

- name: ğŸ” Validar que no exista ya una instalaciÃ³n previa
  ansible.windows.win_stat:
    path: 'C:\\Program Files (x86)\\Nimsoft\\robot\\robot.exe'
  register: nimsoft_installed

- name: ğŸš« Abortar si ya estÃ¡ instalado
  ansible.builtin.fail:
    msg: "âš ï¸ Ya existe una instalaciÃ³n de Nimsoft Robot. Revisa si deseas reinstalar."
  when: nimsoft_installed.stat.exists

- name: ğŸ§ª Verificar conectividad real a MinIO usando GET sin contenido
  ansible.windows.win_uri:
    url: "{{ uim_installer_url }}"
    method: GET
    return_content: no
  register: minio_check
  failed_when: minio_check.status_code != 200
  retries: 3
  delay: 5
  until: minio_check.status_code == 200

- name: âœ… Acceso a MinIO validado correctamente
  ansible.builtin.debug:
    msg: "ğŸ“¦ El instalador fue encontrado correctamente en MinIO: {{ uim_installer_url }}"

- name: âœ… Verificar que las variables crÃ­ticas estÃ©n definidas
  ansible.builtin.assert:
    that:
      - DOMAIN is defined
      - ROBOTIP is defined
      - ROBOTNAME is defined
      - HUBIP is defined
      - HUBPORT is defined
      - FIRST_PROBE_PORT is defined
      - uim_installer_url is defined
    fail_msg: "âŒ Faltan variables necesarias para la instalaciÃ³n de Nimsoft Robot."

- name: ğŸ”’ Congelar URL pre-firmada para todo el rol
  ansible.builtin.set_fact:
    uim_installer_url_final: "{{ uim_installer_url }}"
  run_once: true