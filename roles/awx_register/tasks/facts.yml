---
# ========== OBTENER FACTS DEL SISTEMA ==========
- name: ğŸ§  Recolectar facts del sistema si no estÃ¡n presentes
  ansible.builtin.setup:
  when: ansible_os_family is not defined

- name: ğŸ“‹ Mostrar informaciÃ³n del sistema detectado
  ansible.builtin.debug:
    msg:
      - "ğŸ–¥ï¸  Sistema: {{ ansible_os_family }}"
      - "ğŸ“Œ DistribuciÃ³n: {{ ansible_distribution | default('N/A') }} {{ ansible_distribution_version | default('') }}"
      - "ğŸ” Recolectando hostname e IP..."

# ========== OBTENER HOSTNAME ==========
- name: ğŸ·ï¸  Obtener hostname del sistema
  ansible.builtin.set_fact:
    awx_hostname: "{{ ansible_hostname }}"

- name: âœ… Validar hostname obtenido
  ansible.builtin.assert:
    that:
      - awx_hostname is defined
      - awx_hostname != ""
      - awx_hostname | length > 0
    fail_msg: "âŒ No se pudo obtener el hostname del sistema"

# ========== OBTENER IP ADDRESS ==========
- name: ğŸŒ Obtener IP address principal (Linux)
  ansible.builtin.set_fact:
    awx_ip_address: "{{ ansible_default_ipv4.address }}"
  when: ansible_os_family != 'Windows'

- name: ğŸŒ Obtener IP address principal (Windows)
  ansible.builtin.set_fact:
    awx_ip_address: "{{ item | trim }}"
  loop: "{{ ansible_ip_addresses }}"
  when: 
    - ansible_os_family == 'Windows'
    - item is match('^(?:[0-9]{1,3}\.){3}[0-9]{1,3}$')
    - not item.startswith('127.')
    - not item.startswith('169.254.')
    - awx_ip_address is not defined

- name: âœ… Validar IP address obtenida
  ansible.builtin.assert:
    that:
      - awx_ip_address is defined
      - awx_ip_address != ""
      - awx_ip_address is match("^(?:[0-9]{1,3}\.){3}[0-9]{1,3}$")
    fail_msg: "âŒ IP address no vÃ¡lida o no encontrada: {{ awx_ip_address | default('NO DEFINIDA') }}"

# ========== OBTENER INFORMACIÃ“N ADICIONAL DEL SISTEMA ==========
- name: ğŸ“Š Obtener informaciÃ³n adicional del sistema
  ansible.builtin.set_fact:
    awx_system_info:
      os_family: "{{ ansible_os_family }}"
      distribution: "{{ ansible_distribution | default('Unknown') }}"
      distribution_version: "{{ ansible_distribution_version | default('Unknown') }}"
      kernel: "{{ ansible_kernel | default('Unknown') }}"
      architecture: "{{ ansible_architecture | default('Unknown') }}"

# ========== MOSTRAR FACTS RECOLECTADOS ==========
- name: ğŸ“‹ Mostrar facts recolectados para AWX
  ansible.builtin.debug:
    msg:
      - "ğŸ·ï¸  Hostname: {{ awx_hostname }}"
      - "ğŸŒ IP Address: {{ awx_ip_address }}"
      - "ğŸ–¥ï¸  OS Family: {{ awx_system_info.os_family }}"
      - "ğŸ“Œ Distribution: {{ awx_system_info.distribution }} {{ awx_system_info.distribution_version }}"
      - "âš™ï¸  Architecture: {{ awx_system_info.architecture }}"