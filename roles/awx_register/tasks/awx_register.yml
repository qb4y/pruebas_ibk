---
# ========== REGISTRO EN AWX ==========
- name: ğŸ“¤ Iniciando proceso de registro en AWX
  ansible.builtin.debug:
    msg:
      - "ğŸ¯ Registrando host en AWX"
      - "ğŸ“¦ Inventario: {{ inventory }}"
      - "ğŸ‘¥ Grupo: {{ group }}"
      - "ğŸ–¥ï¸  Host: {{ awx_hostname }}"
      - "ğŸŒ IP: {{ awx_ip_address }}"

# ========== VERIFICAR/CREAR INVENTARIO ==========
- name: ğŸ” Verificar si el inventario '{{ inventory }}' existe en AWX
  ansible.builtin.uri:
    url: "{{ awx_url }}/api/v2/inventories/?name={{ inventory | urlencode }}"
    method: GET
    headers:
      Authorization: "Bearer {{ awx_token }}"
    validate_certs: "{{ awx_verify_ssl }}"
    timeout: "{{ awx_timeout }}"
    status_code: 200
  register: inventory_check
  delegate_to: localhost

- name: ğŸ†• Crear inventario '{{ inventory }}' si no existe
  ansible.builtin.uri:
    url: "{{ awx_url }}/api/v2/inventories/"
    method: POST
    headers:
      Authorization: "Bearer {{ awx_token }}"
      Content-Type: "application/json"
    body_format: json
    body:
      name: "{{ inventory }}"
      description: "Inventario creado automÃ¡ticamente para hosts registrados"
      organization: 1  # Asumiendo organizaciÃ³n por defecto
    validate_certs: "{{ awx_verify_ssl }}"
    timeout: "{{ awx_timeout }}"
    status_code: 201
  register: inventory_creation
  delegate_to: localhost
  when: inventory_check.json.count == 0

- name: âœ… Confirmar inventario disponible
  ansible.builtin.set_fact:
    inventory_id: >-
      {{
        inventory_check.json.results[0].id if inventory_check.json.count > 0
        else inventory_creation.json.id
      }}
  delegate_to: localhost

- name: ğŸ“‹ Mostrar informaciÃ³n del inventario
  ansible.builtin.debug:
    msg:
      - "âœ… Inventario: {{ inventory }}"
      - "ğŸ†” ID del inventario: {{ inventory_id }}"
      - "ğŸ”„ AcciÃ³n: {{ 'Encontrado' if inventory_check.json.count > 0 else 'Creado' }}"
  delegate_to: localhost

# ========== VERIFICAR SI EL HOST YA EXISTE ==========
- name: ğŸ” Verificar si el host '{{ awx_hostname }}' ya existe en el inventario
  ansible.builtin.uri:
    url: "{{ awx_url }}/api/v2/inventories/{{ inventory_id }}/hosts/?name={{ awx_hostname | urlencode }}"
    method: GET
    headers:
      Authorization: "Bearer {{ awx_token }}"
    validate_certs: "{{ awx_verify_ssl }}"
    timeout: "{{ awx_timeout }}"
    status_code: 200
  register: host_check
  delegate_to: localhost

# ========== CREAR O ACTUALIZAR HOST ==========
- name: ğŸ†• Crear nuevo host en AWX
  ansible.builtin.uri:
    url: "{{ awx_url }}/api/v2/inventories/{{ inventory_id }}/hosts/"
    method: POST
    headers:
      Authorization: "Bearer {{ awx_token }}"
      Content-Type: "application/json"
    body_format: json
    body:
      name: "{{ awx_hostname }}"
      description: "Host registrado automÃ¡ticamente - Ambiente: {{ ambiente }}"
      variables: "ansible_host: {{ awx_ip_address }}\nambiente: {{ ambiente }}\nregistered_date: '{{ ansible_date_time.date }}'\nos_family: {{ awx_system_info.os_family }}\ndistribution: {{ awx_system_info.distribution }}"
    validate_certs: "{{ awx_verify_ssl }}"
    timeout: "{{ awx_timeout }}"
    status_code: [201, 400]
  register: host_creation
  delegate_to: localhost
  when: host_check.json.count == 0

- name: ğŸ”„ Actualizar host existente en AWX
  ansible.builtin.uri:
    url: "{{ awx_url }}/api/v2/hosts/{{ host_check.json.results[0].id }}/"
    method: PATCH
    headers:
      Authorization: "Bearer {{ awx_token }}"
      Content-Type: "application/json"
    body_format: json
    body:
      description: "Host actualizado automÃ¡ticamente - Ambiente: {{ ambiente }}"
      variables: "ansible_host: {{ awx_ip_address }}\nambiente: {{ ambiente }}\nupdated_date: '{{ ansible_date_time.date }}'\nos_family: {{ awx_system_info.os_family }}\ndistribution: {{ awx_system_info.distribution }}"
    validate_certs: "{{ awx_verify_ssl }}"
    timeout: "{{ awx_timeout }}"
    status_code: 200
  register: host_update
  delegate_to: localhost
  when: host_check.json.count > 0

# ========== OBTENER ID DEL HOST ==========
- name: ğŸ†” Obtener ID del host creado/actualizado
  ansible.builtin.set_fact:
    host_id: >-
      {{
        host_creation.json.id if (host_check.json.count == 0 and host_creation.status == 201)
        else (host_check.json.results[0].id if host_check.json.count > 0 else 'ERROR')
      }}
  delegate_to: localhost

- name: âŒ Fallar si no se pudo crear/encontrar el host
  ansible.builtin.fail:
    msg: |
      âŒ No se pudo crear o encontrar el host.
      - CreaciÃ³n exitosa: {{ host_creation.status == 201 if host_creation.status is defined else 'No' }}
      - Host existente: {{ host_check.json.count > 0 }}
      - Error creaciÃ³n: {{ host_creation.json if host_creation.json is defined else 'N/A' }}
  when: host_id == 'ERROR'

# ========== VERIFICAR/CREAR GRUPO ==========
- name: ğŸ” Verificar si el grupo '{{ group }}' existe en el inventario
  ansible.builtin.uri:
    url: "{{ awx_url }}/api/v2/inventories/{{ inventory_id }}/groups/?name={{ group | urlencode }}"
    method: GET
    headers:
      Authorization: "Bearer {{ awx_token }}"
    validate_certs: "{{ awx_verify_ssl }}"
    timeout: "{{ awx_timeout }}"
    status_code: 200
  register: group_check
  delegate_to: localhost

- name: ğŸ†• Crear grupo '{{ group }}' si no existe
  ansible.builtin.uri:
    url: "{{ awx_url }}/api/v2/inventories/{{ inventory_id }}/groups/"
    method: POST
    headers:
      Authorization: "Bearer {{ awx_token }}"
      Content-Type: "application/json"
    body_format: json
    body:
      name: "{{ group }}"
      description: "Grupo {{ group }} creado automÃ¡ticamente para hosts {{ ansible_os_family }}"
      inventory: "{{ inventory_id }}"
    validate_certs: "{{ awx_verify_ssl }}"
    timeout: "{{ awx_timeout }}"
    status_code: 201
  register: group_creation
  delegate_to: localhost
  when: group_check.json.count == 0

- name: âœ… Confirmar grupo disponible
  ansible.builtin.set_fact:
    group_id: >-
      {{
        group_check.json.results[0].id if group_check.json.count > 0
        else group_creation.json.id
      }}
  delegate_to: localhost

# ========== ASOCIAR HOST AL GRUPO (SIMULANDO INTERFAZ MANUAL) ==========
- name: ğŸ‘¥ Asociar host al grupo usando el endpoint correcto
  ansible.builtin.uri:
    url: "{{ awx_url }}/api/v2/groups/{{ group_id }}/hosts/"
    method: POST
    headers:
      Authorization: "Bearer {{ awx_token }}"
      Content-Type: "application/json"
    body_format: json
    body:
      associate: true
      id: "{{ host_id | int }}"
    validate_certs: "{{ awx_verify_ssl }}"
    timeout: "{{ awx_timeout }}"
    status_code: [204, 400]
  register: host_group_association
  delegate_to: localhost
  failed_when: false  # No fallar automÃ¡ticamente para manejar errores

- name: ğŸ“‹ Debug - Mostrar detalles de la asociaciÃ³n
  ansible.builtin.debug:
    msg:
      - "ğŸ‘¥ Intentando asociar Host ID: {{ host_id }} al Grupo ID: {{ group_id }}"
      - "ğŸ“Š Status Code: {{ host_group_association.status }}"
      - "ğŸ“ Respuesta: {{ host_group_association.json if host_group_association.json is defined else 'N/A' }}"
      - "âŒ Error: {{ host_group_association.msg if host_group_association.status >= 400 else 'Ninguno' }}"
  delegate_to: localhost

# ========== MÃ‰TODO ALTERNATIVO SI FALLA EL ANTERIOR ==========
- name: ğŸ”„ MÃ©todo alternativo - Usar endpoint de hosts para asociar al grupo
  ansible.builtin.uri:
    url: "{{ awx_url }}/api/v2/hosts/{{ host_id }}/groups/"
    method: POST
    headers:
      Authorization: "Bearer {{ awx_token }}"
      Content-Type: "application/json"
    body_format: json
    body:
      associate: true
      id: "{{ group_id | int }}"
    validate_certs: "{{ awx_verify_ssl }}"
    timeout: "{{ awx_timeout }}"
    status_code: [204, 400]
  register: host_group_association_alt
  delegate_to: localhost
  failed_when: false
  when: host_group_association.status not in [204]

- name: ğŸ“‹ Debug - MÃ©todo alternativo
  ansible.builtin.debug:
    msg:
      - "ğŸ”„ MÃ©todo alternativo - Status: {{ host_group_association_alt.status if host_group_association_alt is defined else 'No ejecutado' }}"
      - "ğŸ“ Respuesta alt: {{ host_group_association_alt.json if host_group_association_alt is defined and host_group_association_alt.json is defined else 'N/A' }}"
  delegate_to: localhost
  when: host_group_association_alt is defined

# ========== TERCER MÃ‰TODO - USANDO CURL DIRECTO ==========
- name: ğŸ› ï¸ MÃ©todo directo usando curl (Ãºltimo recurso)
  ansible.builtin.shell: |
    curl -X POST \
      -H "Authorization: Bearer {{ awx_token }}" \
      -H "Content-Type: application/json" \
      -d '{"associate": true, "id": {{ host_id }}}' \
      "{{ awx_url }}/api/v2/groups/{{ group_id }}/hosts/" \
      -k -s -w "%{http_code}"
  register: curl_association
  delegate_to: localhost
  when: 
    - host_group_association.status not in [204]
    - (host_group_association_alt is not defined or host_group_association_alt.status not in [204])

- name: ğŸ“‹ Debug - Resultado del curl
  ansible.builtin.debug:
    msg:
      - "ğŸ› ï¸ Curl result: {{ curl_association.stdout if curl_association is defined else 'No ejecutado' }}"
  delegate_to: localhost
  when: curl_association is defined

# ========== VERIFICAR ASOCIACIÃ“N FINAL ==========
- name: ğŸ” Verificar que el host estÃ© en el grupo (verificaciÃ³n final)
  ansible.builtin.uri:
    url: "{{ awx_url }}/api/v2/groups/{{ group_id }}/hosts/?name={{ awx_hostname | urlencode }}"
    method: GET
    headers:
      Authorization: "Bearer {{ awx_token }}"
    validate_certs: "{{ awx_verify_ssl }}"
    timeout: "{{ awx_timeout }}"
    status_code: 200
  register: host_in_group_check
  delegate_to: localhost

- name: âœ… Confirmar host en grupo
  ansible.builtin.debug:
    msg:
      - "âœ… Host '{{ awx_hostname }}' estÃ¡ en el grupo '{{ group }}': {{ 'SÃ­' if host_in_group_check.json.count > 0 else 'No' }}"
      - "ğŸ“Š Hosts en grupo: {{ host_in_group_check.json.count }}"
      - "ğŸ¯ Resultado final: {{ 'Ã‰XITO' if host_in_group_check.json.count > 0 else 'FALLÃ“ - Host no asociado al grupo' }}"
  delegate_to: localhost

# ========== ADVERTENCIA SI NO SE PUDO ASOCIAR ==========
- name: âš ï¸ Advertencia si el host no estÃ¡ en el grupo
  ansible.builtin.debug:
    msg:
      - "âš ï¸ ADVERTENCIA: El host se creÃ³ pero NO se pudo asociar al grupo"
      - "ğŸ“ DeberÃ¡s asociarlo manualmente en la interfaz de AWX"
      - "ğŸ–¥ï¸  Host: {{ awx_hostname }} (ID: {{ host_id }})"
      - "ğŸ‘¥ Grupo: {{ group }} (ID: {{ group_id }})"
  delegate_to: localhost
  when: host_in_group_check.json.count == 0

# ========== MOSTRAR RESULTADO FINAL ==========
- name: ğŸ‰ Mostrar resultado del registro
  ansible.builtin.debug:
    msg:
      - "âœ… Host registrado exitosamente en AWX"
      - "ğŸ–¥ï¸  Host: {{ awx_hostname }} (ID: {{ host_id }})"
      - "ğŸŒ ansible_host: {{ awx_ip_address }}"
      - "ğŸ“¦ Inventario: {{ inventory }} (ID: {{ inventory_id }}) - {{ 'Creado' if inventory_check.json.count == 0 else 'Existente' }}"
      - "ğŸ‘¥ Grupo: {{ group }} (ID: {{ group_id }}) - {{ 'Creado' if group_check.json.count == 0 else 'Existente' }}"
      - "ğŸŒ Ambiente: {{ ambiente }}"
      - "ğŸ–¥ï¸  SO: {{ ansible_os_family }}"
      - "ğŸ”„ Host: {{ 'Creado' if host_check.json.count == 0 else 'Actualizado' }}"
  delegate_to: localhost