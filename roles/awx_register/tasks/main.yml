---
# ========== CONTROL PRINCIPAL AWX REGISTER ==========
- name: ğŸš€ Iniciando registro AWX para servidor {{ inventory_hostname }}
  ansible.builtin.debug:
    msg: 
      - "ğŸ“‹ Registrando servidor en AWX"
      - "ğŸ–¥ï¸  Servidor: {{ inventory_hostname }}"
      - "ğŸ“… Fecha: {{ ansible_date_time.date }}"
      - "ğŸŒ Ambiente: {{ ambiente }}"

# ========== VALIDAR VARIABLES DE ENTRADA ==========
- name: âœ… Validar variables requeridas
  ansible.builtin.assert:
    that:
      - ambiente is defined and ambiente != ""
    fail_msg: |
      âŒ Variable requerida no estÃ¡ definida:
      - ambiente: {{ ambiente | default('NO DEFINIDO') }}

# ========== CONFIGURAR VARIABLES AUTOMÃTICAS ==========
- name: ğŸ¯ Configurar inventario y grupo automÃ¡ticamente
  ansible.builtin.set_fact:
    inventory: "inventario de hosts"
    group: >-
      {%- if ansible_os_family == 'Windows' -%}
        windows
      {%- else -%}
        linux
      {%- endif -%}

- name: ğŸ“‹ Mostrar configuraciÃ³n automÃ¡tica
  ansible.builtin.debug:
    msg:
      - "ğŸŒ Ambiente (desde UI): {{ ambiente }}"
      - "ğŸ“¦ Inventario (automÃ¡tico): {{ inventory }}"
      - "ğŸ‘¥ Grupo (por SO): {{ group }}"
      - "ğŸ–¥ï¸  SO detectado: {{ ansible_os_family }}"

# ========== CARGAR CREDENCIALES AWX DESDE VAULT ==========
- name: ğŸ” Cargar credenciales AWX desde Vault
  ansible.builtin.include_tasks: awx_auth.yml

# ========== OBTENER FACTS DEL SISTEMA ==========
- name: ğŸ§  Obtener facts del sistema
  ansible.builtin.include_tasks: facts.yml

# ========== VALIDAR FACTS OBTENIDOS ==========
- name: âœ… Validar facts recolectados
  ansible.builtin.assert:
    that:
      - awx_hostname is defined and awx_hostname != ""
      - awx_ip_address is defined and awx_ip_address != ""
      - awx_ip_address is match("^(?:[0-9]{1,3}\.){3}[0-9]{1,3}$")
    fail_msg: |
      âŒ Facts requeridos no fueron recolectados correctamente:
      - Hostname: {{ awx_hostname | default('NO DEFINIDO') }}
      - IP Address: {{ awx_ip_address | default('NO DEFINIDO') }}

# ========== MOSTRAR RESUMEN DE DATOS ==========
- name: ğŸ“‹ Mostrar resumen de datos para registro
  ansible.builtin.debug:
    msg:
      - "ğŸ·ï¸  Hostname: {{ awx_hostname }}"
      - "ğŸŒ IP Address: {{ awx_ip_address }}"
      - "ğŸŒ Ambiente: {{ ambiente }}"
      - "ğŸ“¦ Inventario AWX: {{ inventory }}"
      - "ğŸ‘¥ Grupo AWX: {{ group }}"
      - "ğŸ”— AWX URL: {{ awx_url }}"

# ========== REGISTRAR EN AWX ==========
- name: ğŸ“¤ Registrar servidor en AWX
  ansible.builtin.include_tasks: awx_register.yml

# ========== FINALIZACIÃ“N ==========
- name: âœ… Registro AWX completado exitosamente
  ansible.builtin.debug:
    msg:
      - "ğŸ‰ Servidor registrado exitosamente en AWX"
      - "ğŸ“¦ Inventario: {{ inventory }}"
      - "ğŸ‘¥ Grupo: {{ group }}"
      - "ğŸ–¥ï¸  Host: {{ awx_hostname }}"
      - "ğŸŒ IP: {{ awx_ip_address }}"