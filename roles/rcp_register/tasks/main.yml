---
# ========== CONTROL PRINCIPAL RCP REGISTER ==========
- name: ğŸš€ Iniciando registro RCP para servidor {{ inventory_hostname }}
  ansible.builtin.debug:
    msg:
      - "ğŸ“‹ Generando registro CSV para RCP"
      - "ğŸ–¥ï¸  Servidor: {{ inventory_hostname }}"
      - "ğŸ“… Fecha: {{ ansible_date_time.date }}"

# ========== OMITIR VAULT Y MINIO ==========
# - name: âœ… Verificar que vault_core se haya ejecutado
#   ansible.builtin.assert:
#     that:
#       - vault_all_secrets is defined
#     fail_msg: |
#       âŒ vault_all_secrets no estÃ¡ definido.
#       AsegÃºrate de que el rol vault_core se ejecute antes de rcp_register.

# - name: ğŸ” Cargar variables de MinIO desde Vault
#   ansible.builtin.set_fact:
#     minio: "{{ vault_all_secrets.registers }}"

# - name: ğŸ” Establecer variables de conexiÃ³n MinIO
#   ansible.builtin.set_fact:
#     minio_host: "{{ minio.vault_minio_host }}"
#     minio_port: "{{ minio.vault_minio_port }}"
#     minio_user: "{{ minio.vault_minio_user }}"
#     minio_password: "{{ minio.vault_minio_password }}"
#     minio_bucket: "{{ minio.vault_minio_bucket_name }}"
#   delegate_to: localhost
#   run_once: true
#   tags: ["vault"]

# - name: âœ… Validar variables de MinIO
#   ansible.builtin.assert:
#     that:
#       - minio_host is defined
#       - minio_port is defined
#       - minio_user is defined
#       - minio_password is defined
#       - minio_bucket is defined
#     fail_msg: "âŒ Variables de MinIO no fueron cargadas correctamente desde Vault"
#   tags: [vault]

# - name: ğŸ“‹ Mostrar configuraciÃ³n MinIO (sin credenciales)
#   ansible.builtin.debug:
#     msg:
#       - "ğŸª£ Bucket: {{ minio_bucket }}"
#       - "ğŸ–¥ï¸  Host: {{ minio_host }}:{{ minio_port }}"
#       - "ğŸ”„ Ejecutado independientemente"

# - name: ğŸ”§ Verificar que MinIO Client (mc) estÃ¡ disponible
#   ansible.builtin.command: mc --version
#   register: mc_version_check
#   failed_when: mc_version_check.rc != 0
#   delegate_to: localhost
#   run_once: true

# - name: âœ… Mostrar versiÃ³n de mc disponible
#   ansible.builtin.debug:
#     msg: "MinIO Client encontrado: {{ mc_version_check.stdout.split('\n')[0] }}"
#   delegate_to: localhost
#   run_once: true

# - name: ğŸ” Configurar alias de MinIO en mc
#   ansible.builtin.command: >
#     mc alias set rcpMinio
#     http://{{ minio_host }}:{{ minio_port }}
#     {{ minio_user }}
#     {{ minio_password }}
#   register: mc_alias_result
#   failed_when: mc_alias_result.rc != 0
#   delegate_to: localhost
#   run_once: true
#   no_log: true

# - name: âœ… Confirmar configuraciÃ³n de alias
#   ansible.builtin.debug:
#     msg: "Alias 'rcpMinio' configurado exitosamente"
#   delegate_to: localhost
#   run_once: true

# - name: ğŸ” Verificar conectividad con MinIO
#   ansible.builtin.command: mc ls rcpMinio/
#   register: mc_connectivity_check
#   failed_when: false
#   delegate_to: localhost
#   run_once: true

# - name: âŒ Fallar si no hay conectividad con MinIO
#   ansible.builtin.fail:
#     msg: "âŒ No se puede conectar a MinIO. Verifica credenciales y conectividad."
#   when: mc_connectivity_check.rc != 0

# - name: âœ… Conectividad con MinIO exitosa
#   ansible.builtin.debug:
#     msg: "ConexiÃ³n establecida con MinIO correctamente"
#   delegate_to: localhost
#   run_once: true

# ğŸ” Asignar variables necesarias manualmente
- name: Asignar variables estÃ¡ticas para entorno de prueba
  ansible.builtin.set_fact:
    minio_host: "minio.fake"
    minio_port: 9000
    minio_user: "user"
    minio_password: "pass"
    minio_bucket: "bucket-rcp"

# ========== RECOLECTAR FACTS ==========
- name: ğŸ§  Recolectar facts del sistema si no estÃ¡n presentes
  ansible.builtin.setup:
  when: ansible_os_family is not defined

# ========== PROCESAMIENTO POR SISTEMA OPERATIVO ==========
- name: ğŸ§ Procesar datos para sistema Linux
  ansible.builtin.include_tasks: linux.yml
  when: ansible_os_family != 'Windows'

- name: ğŸªŸ Procesar datos para sistema Windows
  ansible.builtin.include_tasks: windows.yml
  when: ansible_os_family == 'Windows'

# ========== VALIDACIONES GENERALES ==========
- name: âœ… Validar que se recolectaron todos los datos necesarios
  ansible.builtin.assert:
    that:
      - rcp_hostname is defined and rcp_hostname != ""
      - rcp_ip_address is defined and rcp_ip_address != ""
      - rcp_os_version is defined and rcp_os_version != ""
    fail_msg: |
      âŒ Faltan datos requeridos para el registro RCP:
      - Hostname: {{ rcp_hostname | default('NO DEFINIDO') }}
      - IP: {{ rcp_ip_address | default('NO DEFINIDO') }}  
      - OS Version: {{ rcp_os_version | default('NO DEFINIDO') }}

# ========== GENERAR CSV ==========
- name: ğŸ“„ Generar archivo CSV para registro RCP
  ansible.builtin.template:
    src: rcp_register.csv.j2
    dest: "/tmp/{{ rcp_csv_filename }}"
  delegate_to: localhost

- name: ğŸ” Verificar contenido del archivo CSV generado
  ansible.builtin.slurp:
    src: "/tmp/{{ rcp_csv_filename }}"
  register: csv_content
  delegate_to: localhost

- name: ğŸ“‹ Mostrar contenido del CSV generado
  ansible.builtin.debug:
    msg: "{{ (csv_content.content | b64decode).split('\n') }}"

# ========== VALIDAR CSV ANTES DE SUBIR ==========
- name: âœ… Validar que el CSV contiene los datos esperados
  ansible.builtin.assert:
    that:
      - csv_content.content is defined
      - rcp_hostname in (csv_content.content | b64decode)
      - rcp_ip_address in (csv_content.content | b64decode)
      - rcp_os_version in (csv_content.content | b64decode)
    fail_msg: "âŒ El archivo CSV generado no contiene todos los datos esperados"
  delegate_to: localhost

# âŒ OMITIR SUBIDA REAL A MINIO
# - name: ğŸ“¤ Subir archivo CSV a MinIO
#   ansible.builtin.include_tasks: upload.yml
#   vars:
#     csv_local_path: "/tmp/{{ rcp_csv_filename }}"
#     csv_remote_path: "{{ rcp_csv_filename }}"

# - name: ğŸ§¹ Remover alias temporal de MinIO
#   ansible.builtin.command: mc alias remove rcpMinio
#   failed_when: false
#   delegate_to: localhost
#   run_once: true

# ========== LIMPIEZA Y FINALIZACIÃ“N ==========
- name: ğŸ§¹ Limpiar archivo temporal local
  ansible.builtin.file:
    path: "/tmp/{{ rcp_csv_filename }}"
    state: absent
  delegate_to: localhost

- name: âœ… Registro RCP completado exitosamente
  ansible.builtin.debug:
    msg:
      - "ğŸ‰ Archivo CSV generado correctamente"
      - "ğŸ“ Bucket destino: {{ minio_bucket }}"
      - "ğŸ“„ Nombre de archivo: {{ rcp_csv_filename }}"
      - "ğŸ–¥ï¸  Servidor registrado: {{ rcp_hostname }}"
